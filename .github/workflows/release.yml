name: Build and Release

on:
  push:
    tags:
      - 'v*'  # è§¦å‘æ¡ä»¶: æ¨é€ v* æ ‡ç­¾ (å¦‚ v1.0.0)
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-and-release:
    runs-on: macos-14  # ä½¿ç”¨æœ€æ–°çš„ macOS runner

    steps:
      - name: ğŸ“¥ Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”§ è®¾ç½® Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: ğŸ“¦ å®‰è£… XcodeGen
        run: |
          brew install xcodegen

      - name: ğŸ” æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
        run: |
          xcodebuild -version
          swift --version
          xcodegen --version

      - name: ğŸ—ï¸ ç”Ÿæˆ Xcode é¡¹ç›®
        run: |
          xcodegen generate

      - name: ğŸ”¨ æ„å»ºåº”ç”¨
        run: |
          chmod +x scripts/build.sh
          ./scripts/build.sh

      - name: ğŸ“¦ åˆ›å»º DMG
        run: |
          chmod +x scripts/create-dmg.sh
          ./scripts/create-dmg.sh

      - name: ğŸ“‹ è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          VERSION=$(defaults read "$(pwd)/build/Export/Aura.app/Contents/Info.plist" CFBundleShortVersionString)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "dmg_name=Aura-${VERSION}.dmg" >> $GITHUB_OUTPUT

      - name: ğŸ” è®¡ç®—æ ¡éªŒå’Œ
        run: |
          cd build
          shasum -a 256 *.dmg > checksums.txt
          cat checksums.txt

      - name: ğŸ“¤ åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/Aura-*.dmg
            build/checksums.txt
          body: |
            ## ğŸ‰ Aura v${{ steps.version.outputs.version }}

            ### ğŸ“¥ ä¸‹è½½
            ä¸‹è½½ä¸‹æ–¹çš„ DMG æ–‡ä»¶è¿›è¡Œå®‰è£…

            ### âœ¨ åŠŸèƒ½
            - ğŸ–±ï¸ é¼ æ ‡ç‚¹å‡»é«˜äº®æ•ˆæœ
            - ğŸ¨ å¤šç§é¢œè‰²ä¸»é¢˜
            - âš™ï¸ å¯è‡ªå®šä¹‰è¾¹æ¡†åšåº¦
            - ğŸš€ è½»é‡çº§,ä½èµ„æºå ç”¨

            ### ğŸ“ å®‰è£…è¯´æ˜
            1. ä¸‹è½½ `Aura-${{ steps.version.outputs.version }}.dmg`
            2. æ‰“å¼€ DMG æ–‡ä»¶
            3. å°† Aura æ‹–åŠ¨åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹
            4. é¦–æ¬¡è¿è¡Œæ—¶éœ€è¦åœ¨"ç³»ç»Ÿè®¾ç½® > éšç§ä¸å®‰å…¨æ€§ > è¾…åŠ©åŠŸèƒ½"ä¸­æˆæƒ

            ### ğŸ” æ ¡éªŒå’Œ
            è§ `checksums.txt` æ–‡ä»¶

            ### ğŸ“– å®Œæ•´æ–‡æ¡£
            è®¿é—® [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… å‘å¸ƒå®Œæˆ
        run: |
          echo "ğŸ‰ Release v${{ steps.version.outputs.version }} åˆ›å»ºæˆåŠŸ!"
          echo "ğŸ“¦ DMG: ${{ steps.version.outputs.dmg_name }}"
