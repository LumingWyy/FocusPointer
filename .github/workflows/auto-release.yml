name: Auto Release on Main Push

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/**'
      - '!.github/workflows/**'

permissions:
  contents: write

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” æ£€æŸ¥æ˜¯å¦éœ€è¦å‘å¸ƒ
        id: check
        run: |
          # è·å–å½“å‰ç‰ˆæœ¬å·
          VERSION=$(grep "MARKETING_VERSION:" project.yml | awk '{print $2}' | tr -d '"')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

          # æ£€æŸ¥ tag æ˜¯å¦å·²å­˜åœ¨
          if git rev-parse "v${VERSION}" >/dev/null 2>&1; then
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ Tag v${VERSION} å·²å­˜åœ¨,è·³è¿‡å‘å¸ƒ"
          else
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "âœ… éœ€è¦åˆ›å»ºæ–°ç‰ˆæœ¬ v${VERSION}"
          fi

  build-and-release:
    needs: check-version
    if: needs.check-version.outputs.should_release == 'true'
    runs-on: macos-14

    steps:
      - name: ğŸ“¥ Checkout ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ è®¾ç½® Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          brew install xcodegen

      - name: ğŸ” æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
        run: |
          echo "Version: ${{ needs.check-version.outputs.version }}"
          xcodebuild -version
          swift --version

      - name: ğŸ—ï¸ ç”Ÿæˆ Xcode é¡¹ç›®
        run: |
          xcodegen generate

      - name: ğŸ”¨ æ„å»ºåº”ç”¨
        run: |
          chmod +x scripts/build.sh
          ./scripts/build.sh

      - name: ğŸ“¦ åˆ›å»º DMG
        run: |
          chmod +x scripts/create-dmg.sh
          ./scripts/create-dmg.sh

      - name: ğŸ“‹ è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: info
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          RELEASE_TAG="v${VERSION}"

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "release_tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT
          echo "dmg_name=Aura-${VERSION}.dmg" >> $GITHUB_OUTPUT

      - name: ğŸ” è®¡ç®—æ ¡éªŒå’Œ
        run: |
          cd build
          shasum -a 256 *.dmg > checksums.txt
          cat checksums.txt

      - name: ğŸ“ ç”Ÿæˆ Release Notes
        id: changelog
        run: |
          # è·å–ä¸Šä¸€ä¸ª tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            # é¦–æ¬¡å‘å¸ƒ
            CHANGES=$(git log --pretty=format:"- %s (%h)" --reverse)
          else
            # å¢é‡æ›´æ–°
            CHANGES=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)")
          fi

          # ä¿å­˜åˆ°æ–‡ä»¶
          cat > release-notes.md <<EOF
          ## ğŸ‰ What's New / æ›´æ–°å†…å®¹

          ${CHANGES}

          ## ğŸ“¥ Installation / å®‰è£…

          **English:**
          1. Download \`Aura-${{ steps.info.outputs.version }}.dmg\`
          2. Open the DMG file
          3. Drag Aura to Applications folder
          4. Grant Accessibility permission in System Settings

          **ä¸­æ–‡:**
          1. ä¸‹è½½ \`Aura-${{ steps.info.outputs.version }}.dmg\`
          2. æ‰“å¼€ DMG æ–‡ä»¶
          3. å°† Aura æ‹–åŠ¨åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹
          4. åœ¨"ç³»ç»Ÿè®¾ç½® > éšç§ä¸å®‰å…¨æ€§ > è¾…åŠ©åŠŸèƒ½"ä¸­æˆæƒ

          ## âœ¨ Features / åŠŸèƒ½
          - ğŸ–±ï¸ Mouse click highlighting / é¼ æ ‡ç‚¹å‡»é«˜äº®æ•ˆæœ
          - ğŸ¨ Multiple color themes / å¤šç§é¢œè‰²ä¸»é¢˜
          - ğŸ“ Adjustable border thickness / å¯è‡ªå®šä¹‰è¾¹æ¡†åšåº¦
          - ğŸš€ Lightweight, low resource usage / è½»é‡çº§,ä½èµ„æºå ç”¨

          ## ğŸ” Checksums / æ ¡éªŒå’Œ
          See \`checksums.txt\` file / è§ \`checksums.txt\` æ–‡ä»¶

          ---
          **Full Changelog:** https://github.com/\${{ github.repository }}/compare/${LAST_TAG}...${{ steps.info.outputs.release_tag }}
          EOF

          echo "release_notes_file=release-notes.md" >> $GITHUB_OUTPUT

      - name: ğŸ·ï¸ åˆ›å»º Git Tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ steps.info.outputs.release_tag }}" -m "Release ${{ steps.info.outputs.release_tag }}"
          git push origin "${{ steps.info.outputs.release_tag }}"

      - name: ğŸ“¤ åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.info.outputs.release_tag }}
          name: Aura ${{ steps.info.outputs.release_tag }}
          body_path: release-notes.md
          files: |
            build/Aura-*.dmg
            build/checksums.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… å‘å¸ƒå®Œæˆ
        run: |
          echo "ğŸ‰ Release ${{ steps.info.outputs.release_tag }} created!"
          echo "ğŸ“¦ DMG: ${{ steps.info.outputs.dmg_name }}"
          echo "ğŸ”— URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.info.outputs.release_tag }}"
