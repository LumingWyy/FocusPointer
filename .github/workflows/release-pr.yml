name: Release from PR

on:
  pull_request:
    types:
      - closed
    branches:
      - main

permissions:
  contents: read

jobs:
  release:
    # åªåœ¨ PR åˆå¹¶ä¸”åˆ†æ”¯åä»¥ release å¼€å¤´æ—¶è¿è¡Œ
    if: github.event.pull_request.merged == true && startsWith(github.head_ref, 'release')
    runs-on: macos-14
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ğŸ“¥ Checkout ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ è®¾ç½® Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          brew install xcodegen

      - name: ğŸ” æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
        run: |
          xcodebuild -version
          swift --version
          xcodegen --version

      - name: ğŸ—ï¸ ç”Ÿæˆ Xcode é¡¹ç›®
        run: |
          xcodegen generate

      - name: ğŸ”¨ æ„å»ºåº”ç”¨
        run: |
          chmod +x scripts/build.sh
          ./scripts/build.sh

      - name: ğŸ“¦ åˆ›å»º DMG
        run: |
          chmod +x scripts/create-dmg.sh
          ./scripts/create-dmg.sh

      - name: ğŸ“‹ è·å–ç‰ˆæœ¬å’Œ PR ä¿¡æ¯
        id: info
        run: |
          # ä» Info.plist è·å–ç‰ˆæœ¬å·
          VERSION=$(defaults read "$(pwd)/build/Export/Aura.app/Contents/Info.plist" CFBundleShortVersionString)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "dmg_name=Aura-${VERSION}.dmg" >> $GITHUB_OUTPUT

          # ä» PR æ ‡é¢˜æå–ç‰ˆæœ¬æ ‡ç­¾ (å‡è®¾æ ¼å¼ä¸º "release/v1.0.0" æˆ– PR æ ‡é¢˜ä¸º "v1.0.0")
          PR_TITLE="${{ github.event.pull_request.title }}"
          RELEASE_TAG="${PR_TITLE}"

          # å¦‚æœ PR æ ‡é¢˜ä¸æ˜¯ä»¥ v å¼€å¤´,åˆ™æ·»åŠ  v å‰ç¼€
          if [[ ! "$RELEASE_TAG" =~ ^v ]]; then
            RELEASE_TAG="v${VERSION}"
          fi

          echo "release_tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ Release Tag: ${RELEASE_TAG}"
          echo "ğŸ“¦ Version: ${VERSION}"

      - name: ğŸ” è®¡ç®—æ ¡éªŒå’Œ
        run: |
          cd build
          shasum -a 256 *.dmg > checksums.txt
          cat checksums.txt

      - name: ğŸ·ï¸ åˆ›å»º Release Tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ steps.info.outputs.release_tag }}" -m "Release ${{ steps.info.outputs.release_tag }}"
          git push origin "${{ steps.info.outputs.release_tag }}"

      - name: ğŸ“¤ åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.info.outputs.release_tag }}
          name: Release ${{ steps.info.outputs.release_tag }}
          files: |
            build/Aura-*.dmg
            build/checksums.txt
          body: |
            ## ğŸ‰ Aura ${{ steps.info.outputs.release_tag }}

            ### ğŸ“¥ Download / ä¸‹è½½
            Download the DMG file below to install.
            ä¸‹è½½ä¸‹æ–¹çš„ DMG æ–‡ä»¶è¿›è¡Œå®‰è£…ã€‚

            ### âœ¨ Features / åŠŸèƒ½
            - ğŸ–±ï¸ Mouse click highlighting / é¼ æ ‡ç‚¹å‡»é«˜äº®æ•ˆæœ
            - ğŸ¨ Multiple color themes / å¤šç§é¢œè‰²ä¸»é¢˜
            - ğŸ“ Adjustable border thickness / å¯è‡ªå®šä¹‰è¾¹æ¡†åšåº¦
            - ğŸš€ Lightweight, low resource usage / è½»é‡çº§,ä½èµ„æºå ç”¨

            ### ğŸ“ Installation / å®‰è£…è¯´æ˜

            **English:**
            1. Download `Aura-${{ steps.info.outputs.version }}.dmg`
            2. Open the DMG file
            3. Drag Aura to Applications folder
            4. Grant Accessibility permission in System Settings

            **ä¸­æ–‡:**
            1. ä¸‹è½½ `Aura-${{ steps.info.outputs.version }}.dmg`
            2. æ‰“å¼€ DMG æ–‡ä»¶
            3. å°† Aura æ‹–åŠ¨åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹
            4. åœ¨"ç³»ç»Ÿè®¾ç½® > éšç§ä¸å®‰å…¨æ€§ > è¾…åŠ©åŠŸèƒ½"ä¸­æˆæƒ

            ### ğŸ“‹ Changes / æ›´æ–°å†…å®¹
            ${{ github.event.pull_request.body }}

            ### ğŸ” Checksums / æ ¡éªŒå’Œ
            See `checksums.txt` file / è§ `checksums.txt` æ–‡ä»¶

            ### ğŸ“– Full Documentation / å®Œæ•´æ–‡æ¡£
            [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)

            ---
            **PR:** #${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ’¬ è¯„è®º PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ‰ Release Created Successfully!

            **Release:** [${{ steps.info.outputs.release_tag }}](https://github.com/${context.repo.owner}/${context.repo.repo}/releases/tag/${{ steps.info.outputs.release_tag }})
            **DMG:** \`Aura-${{ steps.info.outputs.version }}.dmg\`

            ### ğŸ“¦ Assets
            - âœ… DMG file uploaded
            - âœ… Checksums generated
            - âœ… Release notes published

            The release is now available for download! ğŸš€`
            })

      - name: âœ… å‘å¸ƒå®Œæˆ
        run: |
          echo "ğŸ‰ Release ${{ steps.info.outputs.release_tag }} created successfully!"
          echo "ğŸ“¦ DMG: ${{ steps.info.outputs.dmg_name }}"
          echo "ğŸ”— URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.info.outputs.release_tag }}"
